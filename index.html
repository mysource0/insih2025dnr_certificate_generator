<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Certificate Editor (CSV + Paste)</title>
    
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/pdfjs-dist@2.16.105/build/pdf.min.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5; margin: 0; padding: 2rem;
        }
        .container {
            background-color: white; padding: 2rem 3rem; border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); width: 100%; max-width: 1200px;
            margin: 0 auto;
        }
        h1 { color: #1c1e21; text-align: center; }
        .main-controls {
            display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; align-items: flex-start;
        }
        .control-group { border: 1px solid #ddd; padding: 1.5rem; border-radius: 8px; }
        .control-group h2 { margin-top: 0; font-size: 1.2rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem; }
        .control-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        .control-grid label { font-weight: bold; font-size: 0.9rem; color: #444; }
        .control-grid input { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        input[type="file"] { padding: 8px; background-color: #f9f9f9; border-radius: 4px; }
        textarea#csv-paste-area {
            width: 100%; height: 150px; font-family: monospace; font-size: 0.9rem;
            padding: 10px; border-radius: 6px; border: 1px solid #ccc;
        }
        button {
            background-color: #1877f2; color: white; border: none; padding: 12px 24px;
            border-radius: 6px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: background-color 0.2s;
            width: 100%; margin-top: 1rem;
        }
        button:hover { opacity: 0.9; }
        #preview-gallery {
            margin-top: 2rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem; border-top: 1px solid #ddd; padding-top: 2rem;
        }
        .preview-item {
            border: 1px solid #ccc; border-radius: 8px; overflow: hidden;
            background-color: #f9f9f9; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .preview-item canvas { width: 100%; height: auto; display: block; }
        .preview-item-info { padding: 1rem; }
        .preview-item-info p { margin: 0; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .preview-item-info .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
        .preview-item-info button { font-size: 0.9rem; padding: 8px 12px; margin-top: 0.5rem; width: 100%; }
        button.edit-btn { background-color: #f0ad4e;}
        button.download-btn { background-color: #42b72a;}
        button.delete-btn { background-color: #d9534f; }
        #modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        #modal-content {
            background: white; padding: 2rem; border-radius: 12px; position: relative;
            max-width: 90vw; max-height: 90vh; overflow: auto;
        }
        #modal-close { position: absolute; top: 15px; right: 20px; font-size: 2rem; cursor: pointer; }
        .editor-container { position: relative; line-height: 0; }
        #editor-canvas { max-width: 100%; height: auto; max-height: 75vh; }
        #drag-handle {
            position: absolute; border: 2px dashed rgba(24, 119, 242, 0.8);
            background-color: rgba(24, 119, 242, 0.2); cursor: move; box-sizing: border-box;
        }
        #edit-input {
            position: absolute; background: white; border: 1px solid #1877f2;
            padding: 5px; box-sizing: border-box; display: none;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Pro Certificate Editor üõ†Ô∏è</h1>
        <div class="main-controls">
            <div class="control-group">
                <h2>1. Provide Data</h2>
                <p style="font-size: 0.9rem; color: #666; margin-top: 0;">Upload a file <strong>OR</strong> paste CSV data below.</p>
                <input type="file" id="csv-file-input" accept=".csv, .txt" style="margin-bottom: 1rem;">
                <textarea id="csv-paste-area" placeholder="Example:&#10;IH001,Name One,CSE,Name Two,CSE&#10;IH002,Name Alpha,ECE,Name Beta,ECE"></textarea>
            </div>
            <div class="control-group">
                <h2>2. Set Initial Styles</h2>
                <div class="control-grid">
                    <div>
                        <label for="x-coord">X-Coordinate (Center)</label>
                        <input type="number" id="x-coord" value="1150">
                    </div>
                    <div>
                        <label for="y-coord">Y-Coordinate (Baseline)</label>
                        <input type="number" id="y-coord" value="820">
                    </div>
                    <div>
                        <label for="max-width">Max Width for Name</label>
                        <input type="number" id="max-width" value="1000">
                    </div>
                    <div>
                        <label for="font-size">Max Font Size</label>
                        <input type="number" id="font-size" value="46">
                    </div>
                </div>
            </div>
        </div>
        <button id="generate-all-btn">3. Process Data & Generate Previews</button>
        <div id="preview-gallery"></div>
    </div>

    <div id="modal">
        <div id="modal-content">
            <span id="modal-close">&times;</span>
            <div class="editor-container">
                <canvas id="editor-canvas"></canvas>
                <div id="drag-handle"></div>
                <input type="text" id="edit-input" />
            </div>
        </div>
    </div>

    <script>
        // --- SETUP ---
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@2.16.105/build/pdf.worker.min.js';
        let certificateStore = [];
        
        // --- DOM ELEMENTS ---
        const csvFileInput = document.getElementById('csv-file-input');
        const csvPasteArea = document.getElementById('csv-paste-area');
        const generateAllBtn = document.getElementById('generate-all-btn');
        const previewGallery = document.getElementById('preview-gallery');
        const modal = document.getElementById('modal');
        const modalClose = document.getElementById('modal-close');
        const editorCanvas = document.getElementById('editor-canvas');
        const dragHandle = document.getElementById('drag-handle');
        const editInput = document.getElementById('edit-input');

        // --- CORE PDF FUNCTIONS ---
        const generatePdf = async (text, settings) => {
            try {
                const templateImageUrl = './certificate-template.jpg';
                const imageBytes = await fetch(templateImageUrl).then(res => res.arrayBuffer());
                const pdfDoc = await PDFLib.PDFDocument.create();
                const certificateImage = await pdfDoc.embedJpg(imageBytes);
                const page = pdfDoc.addPage([certificateImage.width, certificateImage.height]);
                page.drawImage(certificateImage, { x: 0, y: 0, width: certificateImage.width, height: certificateImage.height });
                const font = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);
                
                let fontSize = settings.fontSize;
                let textWidth = font.widthOfTextAtSize(text, fontSize);
                
                while (textWidth > settings.maxWidth && fontSize > 20) {
                    fontSize--;
                    textWidth = font.widthOfTextAtSize(text, fontSize);
                }
                
                const textHeight = font.heightAtSize(fontSize);
                const finalX = settings.x - (textWidth / 2);
                const finalY = settings.y;
                
                page.drawText(text, { x: finalX, y: finalY, font, size: fontSize, color: PDFLib.rgb(0.1, 0.1, 0.1) });
                
                return {
                    pdfBytes: await pdfDoc.save(),
                    textRect: { x: finalX, y: finalY, width: textWidth, height: textHeight, fontSize }
                };
            } catch (error) {
                console.error(`Error generating PDF for "${text}":`, error);
                alert(`Failed to load the certificate template. Make sure 'certificate-template.jpg' is in the same folder as this HTML file.`);
                return null;
            }
        };

        const renderPdfToCanvas = async (canvas, pdfBytes) => {
            const pdf = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
            const page = await pdf.getPage(1);
            const viewport = page.getViewport({ scale: 1.0 });
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
        };

        // --- UI & EVENT FUNCTIONS ---
        const getGlobalSettings = () => ({
            x: parseInt(document.getElementById('x-coord').value, 10),
            y: parseInt(document.getElementById('y-coord').value, 10),
            maxWidth: parseInt(document.getElementById('max-width').value, 10),
            fontSize: parseInt(document.getElementById('font-size').value, 10)
        });

        const renderGallery = () => {
            previewGallery.innerHTML = '';
            certificateStore.forEach((cert, i) => {
                const item = document.createElement('div');
                item.className = 'preview-item';
                item.innerHTML = `
                    <canvas></canvas>
                    <div class="preview-item-info">
                        <p title="${cert.name}">${cert.name}</p>
                        <div class="btn-grid">
                            <button class="edit-btn" data-index="${i}">Edit ‚úèÔ∏è</button>
                            <button class="download-btn" data-index="${i}">Download ‚úÖ</button>
                        </div>
                        <button class="delete-btn" data-index="${i}">Delete üóëÔ∏è</button>
                    </div>
                `;
                previewGallery.appendChild(item);
                renderPdfToCanvas(item.querySelector('canvas'), cert.pdfBytes);
            });
        };

        generateAllBtn.addEventListener('click', async () => {
            const file = csvFileInput.files[0];
            const pastedData = csvPasteArea.value.trim();
            let csvContent = '';

            if (file) {
                csvContent = await file.text();
            } else if (pastedData) {
                csvContent = pastedData;
            } else {
                alert('Please upload a CSV file or paste data into the text box.');
                return;
            }

            generateAllBtn.disabled = true;
            generateAllBtn.textContent = 'Processing...';
            certificateStore = [];

            const lines = csvContent.trim().split('\n');
            const participants = [];

            for (const line of lines) {
                if (!line.trim()) continue;
                const parts = line.split(',');
                if (parts.length < 3) continue; 
                const teamId = parts[0].trim();

                for (let i = 1; i < parts.length; i += 2) {
                    const name = parts[i] ? parts[i].trim() : '';
                    const branch = parts[i + 1] ? parts[i + 1].trim() : '';
                    if (name && branch) {
                        participants.push({ teamId, name, branch });
                    }
                }
            }
            
            if (participants.length === 0) {
                alert('No valid participant data found. Please check the CSV format.');
                generateAllBtn.disabled = false;
                generateAllBtn.textContent = '3. Process Data & Generate Previews';
                return;
            }
            
            const settings = getGlobalSettings();
            for (const p of participants) {
                const displayText = `${p.name} (${p.branch})`;
                const safeName = p.name.replace(/\s+/g, '_');
                const fileName = `${p.teamId}_${safeName}_${p.branch}.pdf`;

                const result = await generatePdf(displayText, settings);
                if (result) {
                    certificateStore.push({
                        name: displayText,
                        fileName: fileName,
                        settings,
                        ...result
                    });
                }
            }

            renderGallery();
            generateAllBtn.disabled = false;
            generateAllBtn.textContent = '3. Process Data & Generate Previews';
        });
        
        previewGallery.addEventListener('click', e => {
            const index = e.target.dataset.index;
            if (index === undefined) return;
            const intIndex = parseInt(index, 10);

            if (e.target.classList.contains('edit-btn')) {
                openEditorModal(intIndex);
            } else if (e.target.classList.contains('download-btn')) {
                downloadPdf(intIndex);
            } else if (e.target.classList.contains('delete-btn')) {
                deleteCertificate(intIndex);
            }
        });
        
        const downloadPdf = (index) => {
            const cert = certificateStore[index];
            const blob = new Blob([cert.pdfBytes], { type: 'application/pdf' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = cert.fileName;
            link.click();
            URL.revokeObjectURL(link.href);
        };

        const deleteCertificate = (index) => {
            if (confirm(`Are you sure you want to delete the certificate for "${certificateStore[index].name}"?`)) {
                certificateStore.splice(index, 1);
                renderGallery();
            }
        };

        // --- MODAL EDITOR LOGIC ---
        let activeEditorIndex = -1;
        modalClose.addEventListener('click', () => modal.style.display = 'none');

        const openEditorModal = async (index) => {
            activeEditorIndex = index;
            const cert = certificateStore[index];
            await renderPdfToCanvas(editorCanvas, cert.pdfBytes);
            
            const canvasRect = editorCanvas.getBoundingClientRect();
            const pdfPageWidth = editorCanvas.width;
            const displayWidth = canvasRect.width;
            const scale = displayWidth / pdfPageWidth;

            dragHandle.style.left = `${cert.textRect.x * scale}px`;
            dragHandle.style.top = `${(editorCanvas.height - cert.textRect.y - cert.textRect.height) * scale}px`;
            dragHandle.style.width = `${cert.textRect.width * scale}px`;
            dragHandle.style.height = `${cert.textRect.height * scale}px`;
            
            modal.style.display = 'flex';
        };
        
        // Note: Full drag-and-drop and inline text editing logic for the modal
        // can be added here if needed, but is excluded for simplicity as it was not in the original request.
    </script>
</body>
</html>
